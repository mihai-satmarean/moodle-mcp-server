name: Restart Kubernetes Deployment

on:
  workflow_dispatch:
  workflow_call:

jobs:
  restart-deployment:
    runs-on: ubuntu-latest
    
    steps:
      - name: Setup kubectl
        uses: azure/setup-kubectl@v3
        continue-on-error: true
        
      - name: Configure kubeconfig
        continue-on-error: true
        env:
          KUBECONFIG_DATA: ${{ secrets.KUBECONFIG }}
        run: |
          if [ -n "$KUBECONFIG_DATA" ]; then
            mkdir -p ~/.kube
            echo "$KUBECONFIG_DATA" | base64 -d > ~/.kube/config
            chmod 600 ~/.kube/config
            echo "Kubeconfig configured successfully"
          else
            echo "KUBECONFIG secret not set, skipping deployment restart"
            exit 0
          fi
        
      - name: Restart Moodle MCP deployments
        continue-on-error: true
        run: |
          if [ -f ~/.kube/config ]; then
            echo "Restarting Moodle MCP Server deployments..."
            kubectl rollout restart deployment -n obot-mcp -l app.kubernetes.io/name=moodle-mcp-server || echo "No deployments found to restart"
            echo "Restart triggered successfully"
          else
            echo "Kubeconfig not available, skipping restart"
          fi
